### Массалық SMS науқанына алушыларды қосу
{{EXAMPLE_QUERY}}

Бір сұрауда тек бір типтегі алушылар туралы деректерді жіберуге рұқсат етіледі:

- нөмірлер/байланыс карталарының ID/байланыс ID тізімі
- байланыс кітабындағы топтардың ID тізімі
- алушылар тізімі бар файл.

Әртүрлі алушылар типтерін бірден жіберуге тырысқанда {{API_INCORRECT_PARAM}} қатесі қайтарылады.
Егер бір науқанға бірнеше көздерден алушыларды қосу қажет болса, оны бірнеше сұрауда орындау керек.

Алушылардың нөмірлерін, контактілерін немесе байланыс карталарын қосқанда, бір сұрауда жүктелетін алушылардың ең көп саны
500 нөмірден аспауы керек. Шектен асқан жағдайда {{API_INCORRECT_PARAM}} қатесі қайтарылады және
алушылар қосылмайды.

Кез келген қажетті байланыстар санын бір науқанға жүктеу үшін тізімді 500 немесе одан аз бөліктерге бөлу қажет
және әрбір бөлікті API арқылы жүктеу керек - алушылар бар тізімге қосылады,
егер **replace=1** параметрі көрсетілмесе.

Нөмірлерді, байланыстарды және карталарды жүктеу веб-сервердің негізгі ағынында орындалады және әрбір
өңделген алушы үшін массив түрінде нәтиже қайтарады (қайтарылатын деректер форматын төменде қараңыз).

Байланыс тобы немесе файлдан жүктеу фондық тапсырма (асинхронды жүктеу) құруды шақырады және
оның күйін қадағалау үшін оның ID қайтарылады. Бұл жағдайда API жауабының коды {{API_BACKGROUND_WAIT}} болады.

Алушылардың нөмірлері халықаралық форматта жіберілуі керек. Нөмірден барлық бөгде таңбалар автоматты түрде жойылады.

Әрбір нөмір ел коды мен оған тиесілі операторға сәйкес хабарлама жіберу мүмкіндігі бойынша тексеріледі.

Барлық тексеруден өтпеген нөмірлер сәйкес қате кодымен (code) қабылданбайды, ал әрбір қосылған
нөмір үшін хабарлама статусының кейінгі сұрауы үшін жасалған хабарламаның ID қайтарылады.

Егер жіберілген барлық алушылар қосылмаса (қателер пайда болса), онда API екі жауап кодтарының бірін қайтаруы мүмкін:

- {{API_PARTIALLY_DONE}} - егер барлық алушылар қосылмаса, бірақ кем дегенде бір алушы тексеруден өтсе
- {{API_NOTHING_DONE}} - егер бірде-бір алушы тексеруден өтпесе.

Алушыларды қосу кезінде науқан басқа процестермен қосудан блокталады, сондықтан бір науқанға бірнеше ағынмен параллельді қосу мүмкін емес.

#### Сұрау параметрлері

| Параметр            | Түрі         | Сипаттамасы                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|---------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`                | integer      | Алушыларды қосу қажет науқанның идентификаторы                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `recipients`        | array string | Қарапайым тарату үшін (мәтіндегі ауыстыру айнымалыларын пайдаланбай) алушыларды мына түрде жіберуге болады:<br><ul><li>алушылар нөмірлері үтірлермен немесе жолдардың ауысуларымен бөлінген жол ретінде;</li><li>бірөлшемді массив ретінде, онда массивтің әрбір элементі алушы нөміріне сәйкес келеді;</li><li>екіөлшемді массив ретінде, онда әрбір элемент - `recipient` кілті және алушы нөмірі бар массив.</li></ul>Шаблондық тарату үшін алушылар екіөлшемді массив түрінде жіберілуі керек, онда әрбір элемент - бұл кілті `recipient` және алушы нөмірі бар массив. Сол сияқты, бұл массивте SMS мәтініндегі ауыстыру айнымалыларының атауларына сәйкес келетін кілттері бар элементтер болуы мүмкін (фигурлық жақшасыз).<br>Бұл ретте, егер мәтінде бар кейбір ауыстыру айнымалылары массивте көрсетілмесе, онда өңдеу `params[placeholdersFlag]` параметрінде берілген мәнге байланысты болады (төменде осы параметрдің сипаттамасын қараңыз). |
| `recipientContacts` | array string | Байланыс кітабындағы контактілердің үтірлермен немесе жолдардың ауысуларымен бөлінген массиві немесе жолы. Байланыс мына түрде көрсетілуі мүмкін: <ul><li>карта идентификаторы. Бұл жағдайда тарату үшін 'мобильді телефон нөмірі' өрісінің мәні қолданылады, ол тарату өрісі ретінде белгіленген;</li><li>{карта идентификаторы}:{карта өрісінің кілті} (мысалы: 123456:mobile, егер мобильді телефон өрісі сіздің кітабыңызда 'mobile' кілтіне ие болса). Көрсетілген карта өрісінің мәні тарату үшін қолданылады.</li></ul> Егер тарату шаблондық болса, мәтіндегі ауыстыру айнымалыларын толтыру үшін деректер тиісті байланыс картасынан қолданылады.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `recipientGroups`   | array string | Байланыс кітабындағы топтардың идентификаторларының үтірлермен немесе жолдардың ауысуларымен бөлінген массиві немесе жолы, ол арқылы науқан құрылады. Егер бір байланыс бірнеше топта болса - ол науқанға бір рет қана қосылады. Егер бірнеше байланыста бірдей телефон нөмірі болса - тек бірінші болып қосылғаны қосылады.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `recipientsFile`    | file         | Алушылар тізімі бар файл объектісі - **CSV** немесе **Excel** (тек **XLS**) файл, халықаралық форматтағы алушылар нөмірлері бар.<br>Қарапайым тарату үшін (мәтіндегі ауыстыру айнымалыларын пайдаланбай) - жолда бір нөмір.<br>Шаблондық тарату үшін - жолда бір нөмір және бірінші жолда `recipient` тақырыбы бар бағанда, ал қалған бағандарда ауыстыру айнымалыларына арналған деректер болуы мүмкін. Мұндай бағандардың тақырыптары (кестенің бірінші жолында) SMS мәтініндегі ауыстыру айнымалыларына қатаң сәйкес келуі керек (фигурлық жақшаларсыз, регистрді ескере отырып). Ауыстыру айнымалы атаулары үшін тек латын әріптері мен цифрлар, сондай-ақ '`_`', '`-`' таңбалары рұқсат етіледі. Бірдей тақырыптары бар бағандар болған жағдайда, қате қайтарылады.<br>Бұл ретте, егер мәтінде бар кейбір ауыстыру айнымалыларына сәйкес бағандар болмаса, онда өңдеу `params[placeholdersFlag]` параметрінде берілген мәнге байланысты болады (төменде осы параметрдің сипаттамасын қараңыз).                                                         |
| `params`            | array        | Қосымша баптаулар (қосымша баптаулар кестесін [осы жерден қараңыз](#add-recipients-params)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

#####  <span data-anchor="add-recipients-params">Қосымша баптаулар</span>

| Параметр                           | Түрі     | Сипаттамасы                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|------------------------------------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `params[replace]`                  | integer | Барлық қосылған алушыларды жою және қайтадан қосуды бастау керектігін көрсетеді:<br>**0** - жоқ, алушыларды бұрын қосылғандарға қосу (әдепкі мәні);<br>**1** - иә, жаңа алушыларды қосар алдында барлық бұрын қосылған алушыларды жою;                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `params[placeholdersFlag]`         | integer | Шаблондық тарату үшін жетіспейтін ауыстыру айнымалыларын өңдеу.<br>Егер мәтінге ауыстыру үшін айнымалылар мәндері табылмаса, келесі әрекеттердің бірі мүмкін:<br>**1** - хабарлама таратуға қосылады, бірақ ауыстыру айнымалылары мәтінде қалай болса солай қалады, ауыстыру орындалмайды (әдепкі әрекет);<br>**2** - хабарлама таратуға қосылады, ал ауыстыру айнымалылары жойылады (егер сіз мәтінде фигурлық жақшаларды пайдалансаңыз және олардың жіберу кезінде жойылуын қаламасаңыз, бұл пайдалы болуы мүмкін);<br>**3** - хабарлама мәтінге ауыстыру үшін деректердің жетіспеуіне байланысты қатемен қабылданбайды.                                                                      |
| `params[recipientsFileEncoding]`   | string  | Алушылар деректері бар файлдың кодталуы. Қол жетімді кодтаулар: **KOI8-R, CP866, WINDOWS-1252, WINDOWS-1251, UTF-8, ASCII, ISO-8859-1, UCS-2**. Әдепкі бойынша: **UTF-8**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `params[recipientsFileSkipHeader]` | integer | Файлдың бірінші жолын өткізіп жіберу және өңдеуді екінші жолдан бастау керектігін көрсетеді. Алушыларды бірінші жолда бағандардың атаулары бар файлдан жүктеген кезде пайдалы. Бұл жағдайда бірінші жолды өткізіп жіберіп, файлды екінші жолдан өңдеуді бастау керек. Мүмкін мәндер:<br>**0** - бірінші жолдан бастау (әдепкі мәні);<br>**1** - файлдың бірінші жолын өткізіп жіберіп, екінші жолдан бастау (шаблондық таратуда мәжбүрлі түрде орнатылған);<br>Шаблондық тарату кезінде бұл параметрдің мәні әрқашан **1** және қайта орнатылмайды, себебі бірінші жолда ауыстыру айнымалыларының атаулары болуы керек. |
| `params[recipientsFileDelimiter]`  | string  | Алушылар деректері бар файлдағы бағандардың бөлгіші, әдепкі бойынша: **,** (үтір). Қажет болған жағдайда кез келген басқа таңбаны қолдануға болады.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `params[recipientsFileEnclosure]`  | string  | Алушылар деректері бар файлдағы мәтіннің қоршауы, әдепкі бойынша: **'** (жалғыз тырнақша). Бұл таңба бағандардағы мәтінді екі жағынан қоршауы керек, осылайша жүйе файлды бағандарға дұрыс талдай алады.                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Сервер жауабы

array | integer : Нөмірлер тізімі, контактілер немесе байланыс карталарынан алушыларды жүктеу кезінде әрбір элементінде алушылар туралы деректер бар массив қайтарылады:

| Өріс        | Түрі     | Сипаттамасы                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `recipient` | string  | Науқанға қосылатын алушының нөмірі                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `code`      | integer | Алушыны қосу нәтижесінің коды:<br>**0** - нөмір сәтті науқанға қосылды<br>**1** - жіберілген деректерде телефон нөмірі жоқ немесе оның мәні бос<br>**2** - жіберілген деректерде телефон нөмірі табылмады (мүмкін, деректер дұрыс форматталмаған)<br>**3** - нөмір халықаралық телефон нөмірлерінің форматына сәйкес келмейді<br>**4** - нөмір науқанға бұрыннан қосылған (таратудан қайталануларды алып тастау)<br>**5** - нөмір стоп-тізімде (бұл сіздің стоп-тізіміңіз немесе жүйенің стоп-тізімі болуы мүмкін)<br>**6** - жіберу шотыңыздың параметрлерімен мақсатты елге шектелген<br>**7** - мақсатты ел мен/немесе операторды анықтау мүмкін емес<br>**8** - жүйеде осы операторға жіберу мүмкіндігі жоқ, жіберу мүмкіндігін нақтылау үшін техникалық қолдау қызметіне хабарласыңыз<br>**20** - жіберілген деректер барлық қажетті ауыстыру айнымалыларын қамтымайды (егер `placeholdersFlag` мәні `1` орнатылған болса)<br>**30** - байланыс картасы байланыс кітабында табылмады (`recipient` мәні `null` болады)<br>**31** - байланыс картасында мобильді нөмір жоқ (`recipient` мәні `null` болады)<br>**32** - байланыс байланыс кітабында табылмады (`recipient` мәні `null` болады)<br>**51** - техникалық себептерге байланысты қысқа сілтеме жасау мүмкін емес<br>**99** - алушы нөмірін қосу кезінде жүйелік қате |
| `messageId` | integer | Нөмір қосылған жағдайда хабарламаның идентификаторы, көрсетілген идентификатор бойынша хабарламаның күйін алуға болады.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `number`    | integer | Пайдаланушы жіберген алушы нөмірінің бастапқы мәні (егер алушы нөмірі жіберілген болса)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `contact`   | integer | Жіберілген байланыстың идентификаторы (егер `recipientContacts` жіберілсе)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

Файлдан алушыларды немесе байланыс топтарын жүктеу кезінде алушыларды қосу фондық тапсырмасының сандық идентификаторы қайтарылады. Фондық тапсырмаларды өңдеу туралы толық ақпаратты [осы жерден табуға болады](/kk/help/api-docs/taskqueue).

#### Қате кодтары

Код                      | Сипаттамасы
-------------------------|----
{{API_VALIDATION}}       | Егер қандай да бір параметрлерде дұрыс емес мәндер бар болса.
{{API_RECORD_NOT_FOUND}} | Егер көрсетілген ID бар науқан табылмаса.
{{API_DATA_UPDATE}}      | Егер көрсетілген науқан алушыларды қосу процесімен немесе науқанның күйі алушыларды қосуға мүмкіндік бермейтін күйде болса.
{{API_INCORRECT_PARAM}}  | Егер алушылардың бірде-бір типі жіберілмесе немесе бір сұрауда бірнеше алушылар типтері жіберілсе.
{{API_PARTIALLY_DONE}}   | Егер барлық жіберілген алушылардың кем дегенде біреуі науқанға қосылмаса.
{{API_NOTHING_DONE}}     | Егер сұрау нәтижесінде бірде-бір алушы науқанға қосылмаса.
{{API_BACKGROUND_WAIT}}  | Егер алушыларды қосу фондық тапсырмасы басталса. Фондық тапсырмаларды өңдеу туралы толық ақпаратты [осы жерден табуға болады](/kk/help/api-docs/taskqueue).

#### Мысалдар

##### Массалық таратуға алушылардың нөмірлерін қосу.
Алушылар тізімін таратуға қосу үшін олардың массивін келесі түрде жіберуге болады:

```
recipients[]=380971112233&recipients[]=79101112233&recipients[]=77071112233
```

немесе осылай:

```
recipients=380971112233,79101112233,77071112233
```

Екі жазу формасы бірдей.

##### Шаблондық тарату үшін деректерді қосу.

SMS мәтіні келесідей деп есептейік: `Сәлеметсіз бе, {name}! {date} күнгі сіздің балансыңыз {balance}{currency}.`
Бұл жағдайда `recipients` параметрінде келесі деректер болуы керек:

```
recipients[0][recipient]=380971112233
&recipients[0][name]=%D0%92%D0%B0%D1%81%D0%B8%D0%BB%D0%B8%D0%B9
&recipients[0][date]=26.10.17
&recipients[0][balance]=123.45
&recipients[0][currency]=%D0%B3%D1%80%D0%BD
&recipients[1][recipient]=380971112255
&recipients[1][name]=%D0%9E%D0%BB%D1%8C%D0%B3%D0%B0
&recipients[1][date]=26.10.17
&recipients[1][balance]=3222.99
&recipients[1][currency]=%D1%80%D1%83%D0%B1
&recipients[2][recipient]=4901122211112
&recipients[2][name]=Markus
&recipients[2][date]=26.10.17
&recipients[2][balance]=555.45
&recipients[2][currency]=eur
```


HTTP сұрауының серверге жіберілетін барлық деректері алдын ала URL кодталу керек (әрбір бағдарламалау тілінде бұл үшін сәйкес функция бар).
