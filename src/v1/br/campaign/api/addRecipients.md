### Adicionar destinatários a uma campanha de SMS em massa
{{EXAMPLE_QUERY}}

Em uma única requisição, é permitida apenas a transferência de dados sobre destinatários de um único tipo:

- lista de números/IDs de cartões de contato/IDs de contatos
- lista de IDs de grupos da agenda de contatos
- arquivo com a lista de destinatários.

Ao tentar transferir vários tipos diferentes de destinatários de uma só vez, o erro {{API_INCORRECT_PARAM}} será retornado.
Se for necessário adicionar destinatários de várias fontes a uma única campanha, isso deve ser feito em várias requisições.

Ao adicionar números de destinatários, contatos ou cartões de contato, o número máximo de destinatários carregados em uma única requisição
não pode exceder 500 números. Se o limite for excedido, o erro {{API_INCORRECT_PARAM}} será retornado e
os destinatários não serão adicionados.

Para carregar qualquer quantidade desejada de contatos em uma única campanha, você deve dividir a lista em porções de 500 ou menos
e carregar cada porção com uma chamada de API separada - os destinatários serão adicionados à lista já existente,
a menos que o parâmetro **replace=1** seja especificado.

O carregamento de números, contatos e cartões é realizado na thread principal do servidor web e retorna o resultado para cada
destinatário processado na forma de um array (veja o formato dos dados retornados abaixo).

O carregamento de um grupo de contatos ou de um arquivo aciona a criação de uma tarefa em segundo plano (carregamento assíncrono) e retorna
seu ID para acompanhamento posterior do status. Neste caso, o código de resposta da API será {{API_BACKGROUND_WAIT}}.

Os números dos destinatários devem ser passados no formato internacional. Todos os caracteres estranhos serão removidos do número automaticamente.

Cada número é verificado quanto à possibilidade de enviar uma mensagem para ele de acordo com o código do país e da operadora a que pertence.

Todos os números que não passarem na verificação serão rejeitados com o código de erro correspondente (code), e para cada número adicionado
será retornado o ID da mensagem criada (messageId) para a possibilidade de solicitação de status posterior.

Se nem todos os destinatários passados foram adicionados (ocorreram erros), a API pode retornar um dos dois códigos de resposta:

- {{API_PARTIALLY_DONE}} - se nem todos os destinatários foram adicionados, mas pelo menos um destinatário passou na verificação
- {{API_NOTHING_DONE}} - se nenhum destinatário passou na verificação.

Durante todo o tempo de adição de destinatários, a campanha é bloqueada para adição por outros processos, portanto, a adição paralela em várias threads a uma única campanha é impossível.

#### Parâmetros da requisição

| Parâmetro            | Tipo          | Descrição                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|---------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`                | integer      | Identificador da campanha na qual os destinatários devem ser adicionados.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `recipients`        | array string | Para um envio normal (sem o uso de variáveis placeholder no texto), os destinatários podem ser passados como:<br><ul><li>string com os números dos destinatários, separados por vírgulas ou quebras de linha;</li><li>array unidimensional, onde cada elemento do array corresponde a um número de destinatário;</li><li>array bidimensional, onde cada elemento é um array contendo um elemento com a chave `recipient` e o número do destinatário como valor.</li></ul>Para um envio de modelo, os destinatários devem ser passados como um array bidimensional, onde cada elemento é um array contendo um elemento com a chave `recipient` e o número do destinatário como valor. Além disso, neste array podem estar elementos com chaves correspondentes aos nomes das variáveis (placeholders) no texto do SMS (sem as chaves envolventes).<br>Neste caso, se algum dos placeholders contidos no texto não for passado no array de dados, o processamento ocorrerá dependendo do valor passado no parâmetro `params[placeholdersFlag]` (veja a descrição deste parâmetro abaixo). |
| `recipientContacts` | array string | Array ou string de contatos da agenda de contatos separados por vírgulas ou quebras de linha. Um contato pode ser especificado como: <ul><li>identificador do cartão. Neste caso, o valor do campo 'número de telefone celular' marcado como campo para envio de correspondências será usado para o envio;</li><li>{identificador do cartão}:{chave do campo do cartão} (por exemplo: 123456:mobile, se o campo de telefone celular em sua agenda tiver a chave 'mobile'). O valor do campo do cartão especificado será usado para o envio.</li></ul> Se o envio for de modelo, os dados para preencher os placeholders no texto serão usados do cartão de contato correspondente.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `recipientGroups`   | array string | Array ou string de identificadores de grupos da agenda de contatos, separados por vírgulas ou quebras de linha, a partir dos quais a campanha será formada. Se o mesmo contato estiver contido em vários grupos, ele será adicionado à campanha apenas uma vez. Se vários contatos contiverem o mesmo número de telefone, apenas o primeiro deles será adicionado.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `recipientsFile`    | file         | Objeto do arquivo carregado com destinatários - arquivo **CSV** ou **Excel** (apenas **XLS**) com números de destinatários no formato internacional.<br>Para envio normal (sem o uso de variáveis placeholder no texto) - números um por linha.<br>Para envio de modelo - números um por linha em uma das colunas com o cabeçalho `recipient`, nas outras colunas podem estar dados para substituição nos placeholders. Os cabeçalhos de tais colunas (na primeira linha da tabela) devem corresponder estritamente aos placeholders no texto do SMS (sem as chaves envolventes, respeitando a diferenciação entre maiúsculas e minúsculas). Para nomes de placeholders, apenas letras latinas e números, bem como os símbolos '`_`','`-`' são permitidos. Se houver colunas com cabeçalhos idênticos, um erro será retornado.<br>Neste caso, se não houver colunas correspondentes para algum dos placeholders contidos no texto, o processamento ocorrerá dependendo do valor passado no parâmetro `params[placeholdersFlag]` (veja a descrição deste parâmetro abaixo).                                                         |
| `params`            | array        | Configurações adicionais (veja a tabela [Configurações Adicionais](#add-recipients-params)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

#####  <span data-anchor="add-recipients-params">Configurações Adicionais</span>

| Parâmetro                           | Tipo     | Descrição                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|------------------------------------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `params[replace]`                  | integer | Indica se todos os destinatários já adicionados devem ser removidos e a adição deve ser iniciada novamente:<br>**0** - não, adicionar destinatários aos já adicionados anteriormente (valor padrão);<br>**1** - sim, remover todos os destinatários adicionados anteriormente antes de adicionar novos;                                                                                                                                                                                                                                                                                                                                                                                                        |
| `params[placeholdersFlag]`         | integer | Processamento de variáveis (placeholders) ausentes para envio de modelo.<br>Se nenhum valor de variável para substituição no texto for encontrado, um dos seguintes comportamentos é possível:<br>**1** - a mensagem é adicionada ao envio, mas os placeholders permanecem no texto como estão, a substituição não ocorre (comportamento padrão);<br>**2** - a mensagem é adicionada e os placeholders são removidos (pode ser útil se você usa chaves no texto e não quer que elas sejam removidas no envio);<br>**3** - a mensagem é rejeitada com um erro informando sobre os dados ausentes para substituição no texto.                                                                      |
| `params[recipientsFileEncoding]`   | string  | Codificação do arquivo com os dados dos destinatários. Codificações disponíveis: **KOI8-R, CP866, WINDOWS-1252, WINDOWS-1251, UTF-8, ASCII, ISO-8859-1, UCS-2**. Padrão: **UTF-8**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `params[recipientsFileSkipHeader]` | integer | Indica se a primeira linha do arquivo deve ser ignorada e o processamento deve ser iniciado a partir da segunda. Útil se o carregamento de destinatários for feito a partir de um arquivo que contém os nomes das colunas na primeira linha. Neste caso, é melhor ignorar a primeira linha e começar a processar o arquivo a partir da segunda linha. Valores possíveis:<br>**0** - começar pela primeira linha (valor padrão);<br>**1** - ignorar a primeira linha do arquivo e começar o processamento a partir da segunda (definido obrigatoriamente no caso de envio de modelo);<br>No caso de envio de modelo, o valor deste parâmetro é sempre **1** e não pode ser substituído, pois a primeira linha deve conter os nomes das variáveis para substituição. |
| `params[recipientsFileDelimiter]`  | string  | Separador de colunas no arquivo com os dados dos destinatários, padrão: **,** (vírgula). Se necessário, você pode usar qualquer outro caractere.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `params[recipientsFileEnclosure]`  | string  | Delimitador de texto no arquivo com os dados dos destinatários, padrão: **'** (aspa simples). Este caractere deve envolver os textos nas colunas que contêm o caractere separador em ambos os lados, para que o sistema possa analisar o arquivo em colunas corretamente.                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Resposta do servidor

array | integer : Ao carregar destinatários de uma lista de números, contatos ou cartões de contato, um array é retornado, cada elemento do qual contém dados sobre os destinatários carregados:

| Campo        | Tipo     | Descrição                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `recipient` | string  | Número do destinatário que está sendo adicionado à campanha.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `code`      | integer | Código do resultado da adição do destinatário:<br>**0** - número adicionado com sucesso à campanha<br>**1** - o número de telefone está ausente nos dados passados ou seu valor está vazio<br>**2** - nenhum número de telefone foi detectado nos dados passados (provavelmente os dados estão formatados incorretamente)<br>**3** - o número não corresponde ao formato internacional de números de telefone<br>**4** - o número já foi adicionado à campanha (exclusão de duplicatas do envio)<br>**5** - o número está na lista de bloqueio (pode ser a sua lista de bloqueio ou a lista de bloqueio do sistema)<br>**6** - o envio para o país de destino é limitado pelas configurações da sua conta<br>**7** - não é possível determinar a operadora e/ou o país de destino<br>**8** - o sistema não tem a possibilidade de enviar para esta operadora, entre em contato com nosso suporte técnico para esclarecer a possibilidade de envio<br>**20** - os dados passados não contêm todos os placeholders necessários (se `placeholdersFlag` estiver definido como `1`)<br>**30** - o cartão de contato não foi encontrado na agenda de contatos (`recipient` será igual a `null`)<br>**31** - o cartão de contato não contém um número de celular (`recipient` será igual a `null`)<br>**32** - o contato não foi encontrado na agenda de contatos (`recipient` será igual a `null`)<br>**51** - por razões técnicas, não é possível criar um link curto no momento<br>**99** - erro de sistema ao adicionar o número do destinatário |
| `messageId` | integer | Identificador da mensagem adicionada, se o número foi adicionado, o status da mensagem pode ser obtido pelo identificador especificado.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `number`    | integer | O valor original do número do destinatário passado pelo usuário (se o número do destinatário foi passado).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `contact`   | integer | Identificador do contato passado (se `recipientContacts` foi passado).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

Ao carregar um arquivo com destinatários ou uma lista de grupos de contatos, é retornado um identificador numérico da tarefa de adição de destinatários em segundo plano. Detalhes sobre o trabalho com tarefas em segundo plano veja [aqui](/br/help/api-docs/taskqueue).

#### Códigos de erro

Código                      | Descrição
-------------------------|----
{{API_VALIDATION}}       | Se algum parâmetro contiver valores inválidos.
{{API_RECORD_NOT_FOUND}} | Se a campanha com o ID especificado não for encontrada.
{{API_DATA_UPDATE}}      | Se a campanha especificada for bloqueada por outro processo de adição de destinatários ou se o status da campanha não permitir a adição de destinatários.
{{API_INCORRECT_PARAM}}  | Se nenhum tipo de destinatário for passado ou se vários tipos de destinatários forem passados em uma única requisição.
{{API_PARTIALLY_DONE}}   | Se, de todos os destinatários passados, pelo menos um não tiver sido adicionado à campanha.
{{API_NOTHING_DONE}}     | Se nenhum destinatário tiver sido adicionado à campanha como resultado da execução da requisição.
{{API_BACKGROUND_WAIT}}  | Se uma tarefa de segundo plano para adicionar destinatários foi iniciada. Detalhes sobre o trabalho com tarefas em segundo plano veja [aqui](/br/help/api-docs/taskqueue).

#### Exemplos

##### Adicionar números de destinatários a um envio em massa.
Para adicionar uma lista de destinatários ao envio, você pode passar o array deles assim:

```
recipients[]=380971112233&recipients[]=79101112233&recipients[]=77071112233
```

ou assim:

```
recipients=380971112233,79101112233,77071112233
```

Ambas as formas de registro são idênticas.

##### Adicionar dados para envio de modelo.

Suponhamos que o texto do SMS seja o seguinte: `Olá, {name}! Seu saldo em {date} é de {balance}{currency}.`
Neste caso, no parâmetro `recipients`, os dados devem ser passados na seguinte forma:

```
recipients[0][recipient]=380971112233
&recipients[0][name]=%D0%92%D0%B0%D1%81%D0%B8%D0%BB%D0%B8%D0%B9
&recipients[0][date]=26.10.17
&recipients[0][balance]=123.45
&recipients[0][currency]=%D0%B3%D1%80%D0%BD
&recipients[1][recipient]=380971112255
&recipients[1][name]=%D0%9E%D0%BB%D1%8C%D0%B3%D0%B0
&recipients[1][date]=26.10.17
&recipients[1][balance]=3222.99
&recipients[1][currency]=%D1%80%D1%83%D0%B1
&recipients[2][recipient]=4901122211112
&recipients[2][name]=Markus
&recipients[2][date]=26.10.17
&recipients[2][balance]=555.45
&recipients[2][currency]=eur
```


Todos os dados nos campos de requisição HTTP transmitidos para o servidor devem ser previamente codificados em string codificada em URL (cada linguagem de programação tem uma função correspondente para isso).





