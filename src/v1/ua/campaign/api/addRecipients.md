### Додавання одержувачів в масову SMS кампанію
{{EXAMPLE_QUERY}}

В одному запиті дозволена передача тільки даних про одержувачів одного типу:

- список номерів / ID контактних карт / ID контактів
- список ID груп з контактної книги
- файл зі списком одержувачів.

При спробі передати відразу кілька різних типів одержувачів буде повернуто помилку {{API_INCORRECT_PARAM}}.
Якщо необхідно додати в одну розсилку одержувачів з декількох джерел, слід зробити це в кілька запитів.

При додаванні номерів одержувачів, контактів або контактних карт максимальна кількість одержувачів, що завантажуються в одному запиті,
не може перевищувати 500 номерів. У разі перевищення ліміту буде повернуто помилку {{API_INCORRECT_PARAM}} і
їх одержувачі не будуть додані.

Для завантаження в одну кампанію будь-якої бажаної кількості контактів слід розбивати список на порції по 500 або менше штук
і завантажувати кожну порцію окремим викликом апі - одержувачі будуть додаватися до вже існуючого списку,
якщо не вказано параметр **replace=1**.

Завантаження номерів, контактів і карт виконується в основному потоці веб-сервера та повертає результат по кожному
обробленому одержувачу у вигляді масиву (див. формат даних, що повертаються, нижче).

Завантаження з контактної групи або з файлу викликає створення фонового завдання (асинхронне завантаження) і повертає
його ID для подальшого відстеження статусу. В цьому випадку код відповіді API буде {{API_BACKGROUND_WAIT}}.

Номери одержувачів повинні передаватися в міжнародному форматі. Всі сторонні символи будуть видалені з номера автоматично.

Кожен номер перевіряється на можливість відправки на нього повідомлення за кодом країни та оператором, якому він належить.

Всі номери, що не пройшли перевірку, будуть відхилені з відповідним кодом помилки (code), а для кожного доданого
номеру буде повернуто ID створеного повідомлення (messageId) для можливості подальшого запиту статусу.

Якщо не всі передані одержувачі були додані (виникли помилки), то API може повернути один з двох кодів відповіді:

- {{API_PARTIALLY_DONE}} - якщо не всі одержувачі були додані, але хоча б один одержувач пройшов перевірку
- {{API_NOTHING_DONE}} - якщо жоден одержувач не пройшов перевірку.

На весь час додавання одержувачів кампанія блокується на додавання іншими процесами, тому паралельне додавання
неможливе.

#### Параметри запиту

 Параметр              | Тип           | Опис
-----------------------|---------------|-----------
`id`                   | integer       | Ідентифікатор кампанії, в яку необхідно додати одержувачів
`recipients`           | array\|string | Для звичайної розсилки одержувачі можуть бути передані у вигляді:<br><ul><li>рядка з номерами одержувачів, розділених комами або переносами рядків;</li><li>одномірного масиву, де кожен елемент масиву відповідає одному номеру одержувача;</li><li>двомірного масиву, де кожен елемент - це масив, що містить елемент з ключем `recipient` і номером одержувача в якості значення.</li></ul>Для шаблонної розсилки одержувачі повинні бути передані у вигляді двомірного масиву, де кожен елемент - це масив, що містить елемент з ключем `recipient` і номером одержувача в якості значення, так само можуть перебувати (але не обов'язково) елементи з ключами, що відповідають назвам змінних (плейсхолдерів) в тексті SMS (без оточуючих їх фігурних дужок).<br>При цьому, якщо якісь із плейсхолдерыв, що містяться в тексті, не передані, то обробка буде відбуватися в залежності від переданого параметра `placeholdersFlag` (див. нижче опис прапора). Приклади запитів див. нижче.
`recipientsCardIds`    | array\|string | Масив або рядок розділених комами або переносами рядків ідентифікаторів контактних карт з контактної книги, за якими буде сформована відправка.
`recipientsContactIds` | array\|string | Масив або рядок розділених комами або переносами рядків ідентифікаторів контактів з контактної книги. <br> Якщо розсилка шаблонна, то дані для заповнення плейсхолдерів в тексті будуть використовуватися з відповідної контактної карти, до якої належить цей контакт.
`recipientsGroupIds`   | array\|string | Масив або рядок розділених комами або переносами рядків ідентифікаторів груп з контактної книги, за якими буде сформована кампанія.
`recipientsFile`       | file          | Масив або рядок розділених комами або переносами рядків ідентифікаторів груп з контактної книги, за якими буде сформована кампанія. <br> Об'єкт завантаженого файлу з одержувачами - файл **CSV** або **Excel** (тільки **XLS**) з номерами одержувачів в міжнародному форматі. <br> Для звичайної розсилки - номери по одному в рядок. <br> Для шаблонної розсилки - номери по одному в рядок в одному з стовпців з заголовком `recipient`, в інших стовпцях можуть бути плейсходери, заголовки стовпців повинні відповідати плейсхолдерам в тексті SMS (без оточуючих фігурних дужок). Для тексту плейсхолдерів дозволені тільки латинські букви і цифри, а також символи '`_`', '`-`'. При наявності стовпців з однаковими заголовками, буде повернуто помилку. <br> При цьому якщо для будь-яких з плейсхолдерів, що містяться в тексті, немає відповідних стовпців, то обробка буде відбуватися в залежності від переданого значення `placeholdersFlag`  параметра `params` (див. нижче опис прапору).
`params`               | array         | Додаткові налаштування (див. таблицю [Додаткові налаштування](#add-recipients-params)).

#####  <span data-anchor="add-recipients-params">Додаткові налаштування</span>

 Параметр                          | Тип     | Опис
-----------------------------------|---------|-----------
`params[replace]`                  | integer | Вказує, чи потрібно видалити всіх уже доданих одержувачів і почати додавання заново:<br>**0** - ні, додати одержувачів до вже доданих раніше (значення за замовчуванням);<br>**1** - так, видалити всіх перед додаванням нових;
`params[placeholdersFlag]`         | integer | Обробка відсутніх змінних (плейсхолдерів) для шаблонної розсилки. <br> Якщо будь-яких значень змінних для підстановки, не знайдено, то можлива одна з наступних поведінок:<br>**1** - повідомлення додається в розсилку, але плейсхолдери залишаються в тексті як є (поведінка за замовчуванням);<br>**2** - повідомлення додається, а плейсхолдери видаляються (якщо потрібно просто відправити, а не відхиляти повідомлення);<br>**3** - повідомлення відхиляється з помилкою, що повідомляє про відсутніх даних для підстановки в текст;<br>
`params[recipientsFileEncoding]`   | string  | Кодування в файлі з даними одержувачів, доступні кодування: **KOI8-R, CP866, WINDOWS-1252, WINDOWS-1251, UTF-8, ASCII, ISO-8859-1, UCS-2**, за замовчуванням: **UTF-8**.
`params[recipientsFileSkipHeader]` | integer | Вказується, чи потрібно пропустити перший рядок файлу і почати обробку з другого. Корисно, якщо завантаження одержувачів відбувається з файлу, в якому в першому рядку знаходяться назви стовпців. У цьому випадку перший рядок краще пропустити і почати обробку файлу з другого рядка. Можливі значення:<br>**0** - починати з першого рядка (значення за замовчуванням);<br>**1** - пропускати перший рядок файлу і починати обробку з другого (примусово встановлено в разі шаблонної розсилки);<br>У разі шаблонної розсилки значення даного параметра завжди дорівнює **1** і не може бути перевизначено, тому що в першому рядку повинні міститися назви змінних для підстановки.<br>
`params[recipientsFileDelimiter]`  | string  | Роздільник стовпців в файлі з даними одержувачів, за замовчуванням: **,** (кома)
`params[recipientsFileEnclosure]`  | string  | Роздільник тексту в файлі з даними одержувачів, за замовчуванням: **'** (одинарні лапки)

#### Відповідь сервера

array | integer : При завантаженні одержувачів зі списку номерів, контактів або контактних карт повертається масив, кожен елемент якого містить дані про завантажених одержувачів:

Поле            | Тип     | Опис
----------------|---------|-----------
`recipient`     | string  | Номер отримувача, який додається в кампанію
`code`          | integer | Код результату додавання одержувача:<br>**0** - номер успішно доданий в кампанію<br>**1** - в переданих даних відсутній номер телефону або його значення порожнє<br>**2** - в переданих даних не виявлено номер телефону (швидше за все дані некоректно відформатовані)<br>**3** - номер не відповідає міжнародному формату телефонних номерів<br>**4** - номер уже був доданий в кампанію (вилучення дублікатів з розсилки)<br>**5** - номер знаходиться в стоп-листі (це може бути як ваш стоп-лист, так і стоп-лист системи)<br>**6** - відправка в країну призначення обмежена налаштуваннями вашого облікового запису<br>**7** - неможливо визначити оператора і / або країну призначення<br>**8** - в системі відсутня можливість відправки на даного оператора, зверніться в нашу технічну підтримку для уточнення можливості відправки<br>**20** - дані, що передаються, не містять всіх необхідних плейсхолдерів (якщо `placeholdersFlag` встановлений в значення `1`)<br>**30** - контактна карта не знайдена в контактній книзі (`recipient` буде дорінювати `null`)<br>**31** - контактна карта не містить мобільного номера (`recipient` буде дорінювати `null`)<br>**32** - контакт не знайдений в контактній книзі (`recipient` буде дорінювати `null`)<br>**51** - з технічних причин на даний момент неможливо створити коротке посилання<br>**99** - системна помилка при додаванні номера одержувача
`messageId`     | integer | Ідентифікатор доданого повідомлення, якщо номер був доданий, за вказаним ідентифікатором можна отримати статус повідомлення.
`number`        | integer | Початкове, передане користувачем значення номера одержувача (якщо переданий номер одержувача)
`contactId`     | integer | Ідентифікатор переданого контакту (якщо передавався `recipientsContactIds`)
`contactCardId` | integer | Ідентифікатор переданої контактної карти (якщо передавався `recipientsCardIds`)

При завантаженні файлу з одержувачами або списку контактних груп повертається числовий ідентифікатор фонового завдання додавання одержувачів. Деталі роботи з фоновими завданнями див. [тут](/uk/help/api-docs/taskqueue).

#### Коди помилок

Код                      | Опис
-------------------------|----
{{API_VALIDATION}}       | Якщо будь-які параметри містять невірні значення.
{{API_RECORD_NOT_FOUND}} | Якщо кампанію з зазначеним ID не знайдено.
{{API_DATA_UPDATE}}      | Якщо зазначена кампанія заблокована іншим процесом додавання одержувачів або статус кампанії не дозволяє додавання одержувачів.
{{API_INCORRECT_PARAM}}  | Якщо не переданий жодний тип одержувачів або передано кілька типів одержувачів в одному запиті.
{{API_PARTIALLY_DONE}}   | Якщо з усіх переданих одержувачів хоча б один не був доданий в кампанію.
{{API_NOTHING_DONE}}     | Якщо жодного одержувача не додано до кампанії в результаті виконання запиту.
{{API_BACKGROUND_WAIT}}  | Якщо було запущено фонове завдання додавання одержувачів. Деталі роботи з фоновими завданнями див. [тут](/uk/help/api-docs/taskqueue).

#### Приклади

##### Додавання номерів одержувачів в масову розсилку.
Для додавання в розсилку списку одержувачів можна передати їх масив ось так:

```
recipients[]=380971112233&recipients[]=79101112233&recipients[]=77071112233
```

або ось так:

```
recipients=380971112233,79101112233,77071112233
```

Обидві форми запису ідентичні.

##### Додавання даних для шаблонної розсилки.

Припустимо, що текст SMS наступний: `Доброго дня, {name}! Ваш баланс на {date} складає {balance}{currency}.`
В такому випадку в параметрі `recipients` повинні бути передані дані виду:

```
recipients[0][recipient]=380971112233
&recipients[0][name]=%D0%92%D0%B0%D1%81%D0%B8%D0%BB%D0%B8%D0%B9
&recipients[0][date]=26.10.17
&recipients[0][balance]=123.45
&recipients[0][currency]=%D0%B3%D1%80%D0%BD
&recipients[1][recipient]=380971112255
&recipients[1][name]=%D0%9E%D0%BB%D1%8C%D0%B3%D0%B0
&recipients[1][date]=26.10.17
&recipients[1][balance]=3222.99
&recipients[1][currency]=%D1%80%D1%83%D0%B1
&recipients[2][recipient]=4901122211112
&recipients[2][name]=Markus
&recipients[2][date]=26.10.17
&recipients[2][balance]=555.45
&recipients[2][currency]=eur
```


Всі дані в переданих на сервер полях HTTP запиту повинні бути попередньо закодовані в URL encoded string (в кожній мові програмування для цього є відповідна функція).
