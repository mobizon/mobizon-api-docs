### Добавление получателей в массовую SMS кампанию
{{EXAMPLE_QUERY}}

В одном запросе разрешена передача только данных о получателях одного типа:

- список номеров/ID контактных карт/ID контактов
- список ID групп из контактной книги
- файл со списком получателей.

При попытке передать сразу несколько разных типов получателей будет возвращена ошибка {{API_INCORRECT_PARAM}}.
Если необходимо добавить в одну рассылку получателей из нескольких источников, следует сделать это в несколько запросов.

При добавлении номеров получателей, контактов или контактных карт максимальное число получателей, загружаемых в одном запросе,
не может превышать 500 номеров. В случае превышения лимита будет возвращена ошибка {{API_INCORRECT_PARAM}} и
получатели не будут добавлены.

Для загрузки в одну кампанию любого желаемого количества контактов следует разбивать список на порции по 500 или меньше штук
и загружать каждую порцию отдельным вызовом апи - получатели будут добавляться к уже существующему списку,
если не указан параметр **replace=1**.

Загрузка номеров, контактов и карт выполняется в основном потоке вебсервера и возвращает результат по каждому
обработанному получателю в виде массива (см. формат возвращаемых данных ниже).

Загрузка из контактной группы или из файла вызывает создание фоновой задачи (асинхронная загрузка) и возвращает
ее ID для дальнейшего отслеживания статуса. В этом случае код ответа API будет {{API_BACKGROUND_WAIT}}.

Номера получателей должны передаваться в международном формате. Все посторонние символы будут удалены из номера автоматически.

Каждый номер проверяется на возможность отправки на него сообщения по коду страны и оператора, которому он принадлежит.

Все не прошедшие проверку номера будут отклонены с соответствующим кодом ошибки (code), а для каждого добавленного
номера будет возвращен ID созданного сообщения (messageId) для возможности последующего запроса статуса.

Если не все переданные получатели были добавлены (возникли ошибки), то API может вернуть один из двух кодов ответа:

- {{API_PARTIALLY_DONE}} - если не все получатели были добавлены, но хотя бы один получатель прошел проверку
- {{API_NOTHING_DONE}} - если ни один получатель не прошел проверку.

На все время добавления получателей кампания блокируется на добавление другими процессами, поэтому параллельное добавление в несколько потоков в одну кампанию невозможно.

#### Параметры запроса

| Параметр             | Тип          | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|----------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`                 | integer      | Идентификатор кампании, в которую необходимо добавить получателей                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `recipients`         | array string | Для обычной рассылки (без использования переменных-плейсхолдеров в тексте) получатели, могут быть переданы в виде:<br><ul><li>строки с номерами получателей, разделенных запятыми или переносами строк;</li><li>одномерного массива, где каждый элемент массива соответствует одному номеру получателя;</li><li>двухмерного массива, где каждый элемент - это массив, содержащий элемент с ключем `recipient` и номером получателя в качестве значения.</li></ul>Для шаблонной рассылки получатели должны быть переданы в виде двухмерного массива, где каждый элемент - это массив, содержащий элемент с ключем `recipient` и номером получателя в качестве значения. Так же в данном массиве могут находиться элементы с ключами, соответствующими названиям переменных (плейсхолдеров) в тексте SMS (без окружающих их фигурных скобок).<br>При этом, если какие-то из плейсхолдеров, содержащихся в тексте, не переданы в массиве с данными, то обработка будет происходить в зависимости от значения, переданного в параметре `params[placeholdersFlag]` (см. ниже описание этого параметра). |
| `recipientsContacts` | array string | Массив или строка разделенных запятыми или переносами строк контактов из контактной книги, контакт может быть указан как идентификатор карты (тогда для рассылки будет использоваться значение поля номера мобильного карты указанного, как поле для отправки рассылок) или в формате {идентификатор карты}:{ключ поля карты}(для рассылки будет использоваться значение указанного поля).<br>Если рассылка шаблонная, то данные для заполнения плейсхолдеров в тексте будут использоваться из соответствующей контактной карты.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `recipientsGroupIds` | array string | Массив или строка разделенных запятыми или переносами строк идентификаторов групп из контактной книги, по которым будет сформирована кампания. Если один и тот же контакт содержится в нескольких группах - он будет добавлен в кампанию только один раз. Если несколько контактов содержат одинаковый номер телефона - добавлен будет только первый из них.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `recipientsFile`     | file         | Объект загруженного файла с получателями - файл **CSV** или **Excel** (только **XLS**) с номерами получателей в международном формате.<br>Для обычной рассылки (без использования переменных-плейсхолдеров в тексте) - номера по одному в строку.<br>Для шаблонной рассылки - номера по одному в строку в одном из столбцов с заголовком `recipient`, в остальных столбцах могут быть данные для подстановки в плейсхолдеры. Заголовки таких столбцов (в первой строке таблицы) должны строго соответствовать плейсхолдерам в тексте SMS (без окружающих фигурных скобок, с учетом регистра символов). Для имен плейсхолдеров разрешены только латинские буквы и цифры, а также символы '`_`', '`-`'. При наличии столбцов с одинаковыми заголовками, будет возвращена ошибка.<br>При этом, если для каких-либо из плейсхолдеров, содержащихся в тексте, нет соответствующих столбцов, то обработка будет происходить в зависимости от значения, переданного в параметре `params[placeholdersFlag]` (см. ниже описание данного параметра).                                                         |
| `params`             | array        | Дополнительные настройки (см. таблицу [Дополнительные настройки](#add-recipients-params)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

#####  <span data-anchor="add-recipients-params">Дополнительные настройки</span>

| Параметр                           | Тип     | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|------------------------------------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `params[replace]`                  | integer | Указывает, нужно ли удалить всех уже добавленных получателей и начать добавление заново:<br>**0** - нет, добавить получателей к уже добавленным ранее (значение по умолчанию);<br>**1** - да, удалить всех добавленных ранее получателей перед добавлением новых;                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `params[placeholdersFlag]`         | integer | Обработка недостающих переменных (плейсхолдеров) для шаблонной рассылки.<br>Если каких либо значений переменных для подстановки в текст не найдено, то возможно одно из следующих поведений:<br>**1** - сообщение добавляется в рассылку, но плейсхолдеры остаются в тексте как есть, замена не происходит (поведение по умолчанию);<br>**2** - сообщение добавляется, а плейсхолдеры удаляются (может быть полезно в случае, если вы используете в тексте фигурные скобки и не хотите, чтобы они были удалены при отправке);<br>**3** - сообщение отклоняется с ошибкой, сообщающей о недостающих данных для подстановки в текст.                                                                      |
| `params[recipientsFileEncoding]`   | string  | Кодировка файла с данными получателей. Доступные кодировки: **KOI8-R, CP866, WINDOWS-1252, WINDOWS-1251, UTF-8, ASCII, ISO-8859-1, UCS-2**. По умолчанию: **UTF-8**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `params[recipientsFileSkipHeader]` | integer | Указывает, нужно ли пропустить первую строку файла и начать обработку со второй. Полезно, если загрузка получателей происходит из файла, в котором в первой строке находятся названия столбцов. В этом случае первую строку лучше пропустить и начать обработку файла со второй строки. Возможные значения:<br>**0** - начинать с первой строки (значение по умолчанию);<br>**1** - пропускать первую строку файла и начинать обработку со второй (принудительно установлено в случае шаблонной рассылки);<br>В случае шаблонной рассылки значение данного параметра всегда равно **1** и не может быть переопределено, так как в первой строке должны содержаться названия переменных для подстановки. |
| `params[recipientsFileDelimiter]`  | string  | Разделитель столбцов в файле с данными получателей, по умолчанию: **,** (запятая). При необходимости вы можете использовать любой другой символ.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `params[recipientsFileEnclosure]`  | string  | Обрамитель текста в файле с данными получателей, по умолчанию: **'** (одинарная кавычка). Данный символ должен обрамлять с двух сторон тексты в столбцах, содержащих символ разделителя, чтобы система могла правильно разобрать файл на столбцы.                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Ответ сервера

array | integer : При загрузке получателей из списка номеров, контактов или контактных карт возвращается массив, каждый элемент которого содержит данные о загруженных получателях:

| Поле        | Тип     | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `recipient` | string  | Номер получателя, который добавляется в кампанию                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `code`      | integer | Код результата добавления получателя:<br>**0** - номер успешно добавлен в кампанию<br>**1** - в переданных данных отсутствует номер телефона или его значение пустое<br>**2** - в переданных данных не обнаружен номер телефона (скорее всего данные некорректно отформатированы)<br>**3** - номер не соответствует международному формату телефонных номеров<br>**4** - номер уже был добавлен в кампанию (исключение дубликатов из рассылки)<br>**5** - номер находится в стоп-листе (это может быть как ваш стоп-лист, так и стоп-лист системы)<br>**6** - отправка в страну назначения ограничена настройками вашего аккаунта<br>**7** - невозможно определить оператора и/или страну назначения<br>**8** - в системе отсутствует возможность отправки на данного оператора, обратитесь в нашу техподдержку для уточнения возможности отправки<br>**20** - переданые данные не содержат всех необходимых плейсхолдеров (если `placeholdersFlag` установлен в значение `1`)<br>**30** - контактная карта не найдена в контактной книге (`recipient` будет равен `null`)<br>**31** - контактная карта не содержит мобильного номера (`recipient` будет равен `null`)<br>**32** - контакт не найден в контактной книге (`recipient` будет равен `null`)<br>**51** - по техническим причинам на данный момент невозможно создать короткую ссылку<br>**99** - системная ошибка при добавлении номера получателя |
| `messageId` | integer | Идентификатор добавленного сообщения, если номер был добавлен, по указанному идентификатору можно получить статус сообщения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `number`    | integer | Исходное, переданное пользователем значение номера получателя (если передан номер получателя)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `contact`   | integer | Идентификатор переданного контакта (если передавался `recipientsContacts`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

При загрузке файла с получателями или списка контактных групп возвращается числовой идентификатор фоновой задачи добавления получателей. Детали работы с фоновыми задачами см. [здесь](/ru/help/api-docs/taskqueue).

#### Коды ошибок

Код                      | Описание
-------------------------|----
{{API_VALIDATION}}       | Если какие либо параметры содержат неверные значения.
{{API_RECORD_NOT_FOUND}} | Если кампания с указанным ID не найдена.
{{API_DATA_UPDATE}}      | Если указанная кампания заблокирована другим процессом добавления получателей или статус кампании не позволяет добавление получателей.
{{API_INCORRECT_PARAM}}  | Если не передан ни один тип получателей или передано несколько типов получателей в одном запросе.
{{API_PARTIALLY_DONE}}   | Если из всех переданных получателей хотя бы один не был добавлен в кампанию.
{{API_NOTHING_DONE}}     | Если ни один получатель не был добавлен в кампанию в результате выполнения запроса.
{{API_BACKGROUND_WAIT}}  | Если была запущена фоновая задача добавления получателей. Детали работы с фоновыми задачами см. [здесь](/ru/help/api-docs/taskqueue).

#### Примеры

##### Добавление номеров получателей в массовую рассылку.
Для добавления в рассылку списка получателей можно передать их массив вот так:

```
recipients[]=380971112233&recipients[]=79101112233&recipients[]=77071112233
```

или вот так:

```
recipients=380971112233,79101112233,77071112233
```

Обе формы записи идентичны.

##### Добавление данных для шаблонной рассылки.

Предположим, что текст SMS следующий: `Здравствуйте, {name}! Ваш баланс на {date} составляет {balance}{currency}.`
В таком случае в параметре `recipients` должны быть переданы данные вида:

```
recipients[0][recipient]=380971112233
&recipients[0][name]=%D0%92%D0%B0%D1%81%D0%B8%D0%BB%D0%B8%D0%B9
&recipients[0][date]=26.10.17
&recipients[0][balance]=123.45
&recipients[0][currency]=%D0%B3%D1%80%D0%BD
&recipients[1][recipient]=380971112255
&recipients[1][name]=%D0%9E%D0%BB%D1%8C%D0%B3%D0%B0
&recipients[1][date]=26.10.17
&recipients[1][balance]=3222.99
&recipients[1][currency]=%D1%80%D1%83%D0%B1
&recipients[2][recipient]=4901122211112
&recipients[2][name]=Markus
&recipients[2][date]=26.10.17
&recipients[2][balance]=555.45
&recipients[2][currency]=eur
```


Все данные в передаваемых на сервер полях HTTP запроса должны быть предварительно закодированы в URL encoded string (в каждом языке программирования для этого есть соответствующая функция).
