### Додавання одержувачів в масову SMS кампанію
{{EXAMPLE_QUERY}}

В одному запиті дозволена передача тільки даних про одержувачів одного типу:

- список номерів/ID контактних карт/ID контактів
- список ID груп із контактної книги
- файл зі списком одержувачів.

При спробі передати відразу кілька різних типів одержувачів буде повернута помилка {{API_INCORRECT_PARAM}}.
Якщо необхідно додати в одну розсилку одержувачів із кількох джерел, слід зробити це в кілька запитів.

При додаванні номерів одержувачів, контактів або контактних карт максимальне число одержувачів, що завантажуються в одному запиті,
не може перевищувати 500 номерів. У разі перевищення ліміту буде повернута помилка {{API_INCORRECT_PARAM}} і
одержувачі не будуть додані.

Для завантаження в одну кампанію будь-якої бажаної кількості контактів слід розбивати список на порції по 500 або менше штук
і завантажувати кожну порцію окремим викликом апі - одержувачі будуть додаватися до вже існуючого списку,
якщо не вказано параметр **replace=1**.

Завантаження номерів, контактів і карт виконується в основному потоці вебсервера і повертає результат по кожному
обробленому одержувачу у вигляді масиву (див. формат даних, що повертаються, нижче).

Завантаження із контактної групи або з файлу викликає створення фонової задачі (асинхронне завантаження) і повертає
її ID для подальшого відстеження статусу. У цьому випадку код відповіді API буде {{API_BACKGROUND_WAIT}}.

Номери одержувачів повинні передаватися в міжнародному форматі. Всі сторонні символи будуть видалені з номера автоматично.

Кожен номер перевіряється на можливість відправки на нього повідомлення за кодом країни та оператора, якому він належить.

Всі номери, що не пройшли перевірку, будуть відхилені з відповідним кодом помилки (code), а для кожного доданого
номера буде повернуто ID створеного повідомлення (messageId) для можливості подальшого запиту статусу.

Якщо не всі передані одержувачі були додані (виникли помилки), то API може повернути один із двох кодів відповіді:

- {{API_PARTIALLY_DONE}} - якщо не всі одержувачі були додані, але хоча б один одержувач пройшов перевірку
- {{API_NOTHING_DONE}} - якщо жоден одержувач не пройшов перевірку.

На весь час додавання одержувачів кампанія блокується на додавання іншими процесами, тому паралельне додавання в кілька потоків в одну кампанію неможливе.

#### Параметри запиту

| Параметр            | Тип          | Опис                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|---------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`                | integer      | Ідентифікатор кампанії, в яку необхідно додати одержувачів                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `recipients`        | array string | Для звичайної розсилки (без використання змінних-плейсхолдерів у тексті) одержувачі можуть бути передані у вигляді:<br><ul><li>рядка з номерами одержувачів, розділених комами або перенесеннями рядків;</li><li>одновимірного масиву, де кожен елемент масиву відповідає одному номеру одержувача;</li><li>двовимірного масиву, де кожен елемент - це масив, що містить елемент із ключем `recipient` і номером одержувача як значення.</li></ul>Для шаблонної розсилки одержувачі повинні бути передані у вигляді двовимірного масиву, де кожен елемент - це масив, що містить елемент із ключем `recipient` і номером одержувача як значення. Також у цьому масиві можуть бути елементи з ключами, відповідними назвам змінних (плейсхолдерів) у тексті SMS (без оточуючих їх фігурних дужок).<br>При цьому, якщо якісь із плейсхолдерів, що містяться в тексті, не передані в масиві з даними, то обробка відбуватиметься залежно від значення, переданого в параметрі `params[placeholdersFlag]` (див. нижче опис цього параметра). |
| `recipientContacts` | array string | Масив або рядок, розділений комами або перенесеннями рядків контактів із контактної книги. Контакт може бути вказаний як: <ul><li>ідентифікатор картки. У цьому разі для розсилки буде використовуватися значення поля 'номер мобільного телефону', позначеного як поле для відправлення розсилок;</li><li>{ідентифікатор картки}:{ключ поля картки} (наприклад: 123456:mobile, якщо поле мобільного телефону у вашій книзі має ключ 'mobile'). Для розсилки буде використовуватися значення вказаного поля картки.</li></ul> Якщо розсилка шаблонна, то дані для заповнення плейсхолдерів у тексті будуть використовуватися з відповідної контактної картки.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `recipientGroups`   | array string | Масив або рядок, розділений комами або перенесеннями рядків ідентифікаторів груп із контактної книги, за якими буде сформовано кампанію. Якщо один і той самий контакт міститься в кількох групах - він буде доданий до кампанії тільки один раз. Якщо кілька контактів містять однаковий номер телефону - доданий буде тільки перший із них.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `recipientsFile`    | file         | Об'єкт завантаженого файлу з одержувачами - файл **CSV** або **Excel** (тільки **XLS**) із номерами одержувачів у міжнародному форматі.<br>Для звичайної розсилки (без використання змінних-плейсхолдерів у тексті) - номери по одному в рядку.<br>Для шаблонної розсилки - номери по одному в рядку в одному зі стовпців із заголовком `recipient`, в інших стовпцях можуть бути дані для підстановки в плейсхолдери. Заголовки таких стовпців (у першому рядку таблиці) повинні строго відповідати плейсхолдерам у тексті SMS (без оточуючих фігурних дужок, з урахуванням регістру символів). Для імен плейсхолдерів дозволені тільки латинські букви та цифри, а також символи '`_`', '`-`'. У разі наявності стовпців із однаковими заголовками, буде повернута помилка.<br>При цьому, якщо для якихось із плейсхолдерів, що містяться в тексті, немає відповідних стовпців, то обробка відбуватиметься залежно від значення, переданого в параметрі `params[placeholdersFlag]` (див. нижче опис цього параметра).                                                         |
| `params`            | array        | Додаткові налаштування (див. таблицю [Додаткові налаштування](#add-recipients-params)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

#####  <span data-anchor="add-recipients-params">Додаткові налаштування</span>

| Параметр                           | Тип     | Опис                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|------------------------------------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `params[replace]`                  | integer | Вказує, чи потрібно видалити всіх уже доданих одержувачів і почати додавання заново:<br>**0** - ні, додати одержувачів до вже доданих раніше (значення за замовчуванням);<br>**1** - так, видалити всіх доданих раніше одержувачів перед додаванням нових;                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `params[placeholdersFlag]`         | integer | Обробка відсутніх змінних (плейсхолдерів) для шаблонної розсилки.<br>Якщо якихось значень змінних для підстановки в текст не знайдено, то можливе одне з таких поведінок:<br>**1** - повідомлення додається в розсилку, але плейсхолдери залишаються в тексті як є, заміна не відбувається (поведінка за замовчуванням);<br>**2** - повідомлення додається, а плейсхолдери видаляються (може бути корисно в разі, якщо ви використовуєте в тексті фігурні дужки і не хочете, щоб вони були видалені під час відправки);<br>**3** - повідомлення відхиляється з помилкою, що повідомляє про відсутні дані для підстановки в текст.                                                                      |
| `params[recipientsFileEncoding]`   | string  | Кодування файлу з даними одержувачів. Доступні кодування: **KOI8-R, CP866, WINDOWS-1252, WINDOWS-1251, UTF-8, ASCII, ISO-8859-1, UCS-2**. За замовчуванням: **UTF-8**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `params[recipientsFileSkipHeader]` | integer | Вказує, чи потрібно пропустити перший рядок файлу та почати обробку з другого. Корисно, якщо завантаження одержувачів відбувається з файлу, в якому в першому рядку знаходяться назви стовпців. У цьому випадку перший рядок краще пропустити і почати обробку файлу з другого рядка. Можливі значення:<br>**0** - починати з першого рядка (значення за замовчуванням);<br>**1** - пропускати перший рядок файлу і починати обробку з другого (примусово встановлено в разі шаблонної розсилки);<br>У разі шаблонної розсилки значення цього параметра завжди дорівнює **1** і не може бути перевизначено, оскільки в першому рядку повинні міститися назви змінних для підстановки. |
| `params[recipientsFileDelimiter]`  | string  | Роздільник стовпців у файлі з даними одержувачів, за замовчуванням: **,** (кома). За потреби ви можете використовувати будь-який інший символ.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `params[recipientsFileEnclosure]`  | string  | Обрамлювач тексту у файлі з даними одержувачів, за замовчуванням: **'** (одинарна лапка). Цей символ має обрамляти з двох сторін тексти в стовпцях, що містять символ роздільника, щоб система могла правильно розібрати файл на стовпці.                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Відповідь сервера

array | integer : При завантаженні одержувачів зі списку номерів, контактів або контактних карт повертається масив, кожен елемент якого містить дані про завантажених одержувачів:

| Поле        | Тип     | Опис                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `recipient` | string  | Номер одержувача, який додається в кампанію                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `code`      | integer | Код результату додавання одержувача:<br>**0** - номер успішно доданий у кампанію<br>**1** - у переданих даних відсутній номер телефону або його значення порожнє<br>**2** - у переданих даних не виявлено номер телефону (швидше за все дані некоректно відформатовані)<br>**3** - номер не відповідає міжнародному формату телефонних номерів<br>**4** - номер уже був доданий у кампанію (виключення дублікатів із розсилки)<br>**5** - номер знаходиться в стоп-листі (це може бути як ваш стоп-лист, так і стоп-лист системи)<br>**6** - відправка в країну призначення обмежена налаштуваннями вашого акаунту<br>**7** - неможливо визначити оператора та/або країну призначення<br>**8** - у системі відсутня можливість відправки на цього оператора, зверніться в нашу техпідтримку для уточнення можливості відправки<br>**20** - передані дані не містять усіх необхідних плейсхолдерів (якщо `placeholdersFlag` встановлено в значення `1`)<br>**30** - контактну картку не знайдено в контактній книзі (`recipient` буде дорівнювати `null`)<br>**31** - контактна картка не містить мобільного номера (`recipient` буде дорівнювати `null`)<br>**32** - контакт не знайдено в контактній книзі (`recipient` буде дорівнювати `null`)<br>**51** - з технічних причин на цей момент неможливо створити коротке посилання<br>**99** - системна помилка під час додавання номера одержувача |
| `messageId` | integer | Ідентифікатор доданого повідомлення, якщо номер було додано, за вказаним ідентифікатором можна отримати статус повідомлення.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `number`    | integer | Вихідне, передане користувачем значення номера одержувача (якщо передано номер одержувача)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `contact`   | integer | Ідентифікатор переданого контакту (якщо передавався `recipientContacts`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

При завантаженні файлу з одержувачами або списку контактних груп повертається числовий ідентифікатор фонової задачі додавання одержувачів. Деталі роботи з фоновими задачами див. [тут](/help/api-docs/taskqueue).

#### Коди помилок

Код                      | Опис
-------------------------|----
{{API_VALIDATION}}       | Якщо якісь параметри містять неправильні значення.
{{API_RECORD_NOT_FOUND}} | Якщо кампанію з указаним ID не знайдено.
{{API_DATA_UPDATE}}      | Якщо вказану кампанію заблоковано іншим процесом додавання одержувачів або статус кампанії не дозволяє додавання одержувачів.
{{API_INCORRECT_PARAM}}  | Якщо не передано жодного типу одержувачів або передано кілька типів одержувачів в одному запиті.
{{API_PARTIALLY_DONE}}   | Якщо з усіх переданих одержувачів хоча б один не був доданий у кампанію.
{{API_NOTHING_DONE}}     | Якщо жоден одержувач не був доданий у кампанію в результаті виконання запиту.
{{API_BACKGROUND_WAIT}}  | Якщо було запущено фонову задачу додавання одержувачів. Деталі роботи з фоновими задачами див. [тут](/help/api-docs/taskqueue).

#### Приклади

##### Додавання номерів одержувачів у масову розсилку.
Для додавання в розсилку списку одержувачів можна передати їх масив ось так:

```
recipients[]=380971112233&recipients[]=79101112233&recipients[]=77071112233
```

або ось так:

```
recipients=380971112233,79101112233,77071112233
```

Обидві форми запису ідентичні.

##### Додавання даних для шаблонної розсилки.

Припустимо, що текст SMS наступний: `Доброго дня, {name}! Ваш баланс на {date} становить {balance}{currency}.`
У такому разі в параметрі `recipients` повинні бути передані дані виду:

```
recipients[0][recipient]=380971112233
&recipients[0][name]=%D0%92%D0%B0%D1%81%D0%B8%D0%BB%D0%B8%D0%B9
&recipients[0][date]=26.10.17
&recipients[0][balance]=123.45
&recipients[0][currency]=%D0%B3%D1%80%D0%BD
&recipients[1][recipient]=380971112255
&recipients[1][name]=%D0%9E%D0%BB%D1%8C%D0%B3%D0%B0
&recipients[1][date]=26.10.17
&recipients[1][balance]=3222.99
&recipients[1][currency]=%D1%80%D1%83%D0%B1
&recipients[2][recipient]=4901122211112
&recipients[2][name]=Markus
&recipients[2][date]=26.10.17
&recipients[2][balance]=555.45
&recipients[2][currency]=eur
```


Всі дані в переданих на сервер полях HTTP запиту повинні бути попередньо закодовані в URL encoded string (у кожній мові програмування для цього є відповідна функція).
